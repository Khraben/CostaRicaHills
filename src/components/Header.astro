---
const { userPhoto = "src/assets/userDefault.jpg" } = Astro.props;
import "../styles/Header.css";
import { auth } from "../../config/firebase.ts";
import {
  onAuthStateChanged,
  signInWithEmailAndPassword,
  signOut,
} from "firebase/auth";
let isLoggedIn = false;
let userName = "";
let userPhotoUrl = userPhoto;

onAuthStateChanged(auth, (user) => {
  if (user) {
    isLoggedIn = true;
    userName = user.displayName || user.email;
    userPhotoUrl = user.photoURL || "src/assets/userDefault.jpg";
  } else {
    isLoggedIn = false;
  }
});
---

<header class="navbar">
  <nav>
    <div class="logo-container">
      <a href="/">
        <img src="src/assets/Logo Costa Rica Hills sin fondo.png" alt="Logo" />
        <span>Costa Rica Hills</span>
      </a>
    </div>

    <div class="nav-links">
      <a href="/tours">Tours</a>
      <a href="/about">Sobre Nosotros</a>

      <!-- Foto del usuario -->
      <img
        src={userPhotoUrl}
        alt="Foto de Usuario"
        class="user-photo"
        id="user-photo"
      />
    </div>
  </nav>

  <div id="login-modal" class="modal" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation();">
      <span
        class="close"
        onclick="document.getElementById('login-modal').style.display='none'"
        >&times;</span
      >
      <h2 id="modal-title">Iniciar Sesión</h2>
      <div id="user-info" style="display: none;">
        <img src={userPhotoUrl} alt="Foto de Usuario" class="login-link" />
        <p id="user-name">{userName}</p>
        <button id="logout-button">Cerrar Sesión</button>
      </div>
      <div id="login-form" style="display: block;">
        <form>
          <label for="email">Correo:</label>
          <input type="email" id="email" required />
          <label for="password">Contraseña:</label>
          <input type="password" id="password" required />
          <button type="submit">Iniciar Sesión</button>
          <button type="button" id="google-login-button" class="google-button">
            <img
              src="src/assets/google-logo.png"
              alt="Google Logo"
              style="height: 20px; vertical-align: middle; margin-right: 5px;"
            />
            Iniciar Sesión con Google
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    import { toggleModal } from "/config/firebase.ts";
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("login-modal");
      document.getElementById("user-photo").addEventListener("click", () => {
        const userInfo = document.getElementById("user-info");
        const loginForm = document.getElementById("login-form");
        modal.style.display = "block"; // Mostrar el modal
        if (isLoggedIn) {
          document.getElementById("modal-title").textContent =
            "Información del Usuario";
          userInfo.style.display = "block";
          loginForm.style.display = "none";
          document.getElementById("user-name").textContent = userName; // Actualiza el nombre del usuario
        } else {
          document.getElementById("modal-title").textContent = "Iniciar Sesión";
          userInfo.style.display = "none";
          loginForm.style.display = "block";
        }
      });
      document
        .getElementById("login-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
            modal.style.display = "none"; // Cierra el modal
          } catch (error) {
            console.error("Error al iniciar sesión:", error);
            alert("Error al iniciar sesión. Verifica tus credenciales.");
          }
        });
      document
        .getElementById("logout-button")
        .addEventListener("click", async () => {
          try {
            await signOut(auth);
            modal.style.display = "none"; // Cierra el modal
          } catch (error) {
            console.error("Error al cerrar sesión:", error);
          }
        });
      document
        .getElementById("google-login-button")
        .addEventListener("click", async (event) => {
          event.preventDefault();
          await toggleModal(); // Llama a la función toggleModal para el inicio de sesión con Google
        });
    });
  </script>
  <script>
    window.addEventListener("scroll", function () {
      const header = document.querySelector(".navbar");
      if (window.scrollY > 50) {
        header.classList.add("scrolled");
      } else {
        header.classList.remove("scrolled");
      }
    });
  </script>
</header>
